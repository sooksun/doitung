// Prisma Schema for TSQM-n แม่ฟ้าหลวง
// Database: MySQL
// ORM: Prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE HIERARCHY
// ============================================

// สำนักงานเขตพื้นที่การศึกษา
model EducationOffice {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  code      String?  @unique @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  networks Network[]
  users    User[]

  @@map("education_offices")
}

// กลุ่มเครือข่าย
model Network {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  code      String?  @db.VarChar(50)
  officeId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  office  EducationOffice @relation(fields: [officeId], references: [id], onDelete: Cascade)
  schools School[]
  users   User[]

  @@index([officeId])
  @@map("networks")
}

// โรงเรียน
model School {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  code      String?  @db.VarChar(50)
  networkId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  network  Network   @relation(fields: [networkId], references: [id], onDelete: Cascade)
  users    User[]
  assessments Assessment[]

  // DE Relations
  learningLogs       LearningLog[]
  plcSessions        PLCSession[]
  studentSignals     StudentSignal[]
  experiments        Experiment[]
  monthlyReflections MonthlyReflection[]

  @@index([networkId])
  @@map("schools")
}

// ============================================
// ACADEMIC YEAR & SEMESTER
// ============================================

// ปีการศึกษา
model AcademicYear {
  id        String   @id @default(uuid())
  year      Int      @unique // เช่น 2567, 2568
  name      String   @db.VarChar(100) // เช่น "ปีการศึกษา 2567"
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  semesters Semester[]
  assessments Assessment[]

  @@map("academic_years")
}

// ภาคเรียน
model Semester {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(100) // เช่น "ภาคเรียนที่ 1"
  academicYearId String
  startDate     DateTime?
  endDate       DateTime?
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  assessments  Assessment[]

  @@index([academicYearId])
  @@map("semesters")
}

// ============================================
// USER MANAGEMENT
// ============================================

// ผู้ใช้งาน
model User {
  id        String   @id @default(uuid())
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255) // bcrypt hashed
  firstName String   @db.VarChar(100)
  lastName  String   @db.VarChar(100)
  role      UserRole @default(VIEWER)
  phone     String?  @db.VarChar(20)
  isActive  Boolean  @default(true)
  
  // Multi-tenant relationships
  officeId  String?
  networkId String?
  schoolId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  // Relations
  office     EducationOffice? @relation(fields: [officeId], references: [id], onDelete: SetNull)
  network    Network?        @relation(fields: [networkId], references: [id], onDelete: SetNull)
  school     School?         @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  assessments Assessment[]    // ผู้ใช้ที่สร้างแบบประเมิน

  // DE Relations
  learningLogs       LearningLog[]
  plcSessions        PLCSession[]
  studentSignals     StudentSignal[]
  experiments        Experiment[]
  monthlyReflections MonthlyReflection[]

  @@index([email])
  @@index([role])
  @@index([officeId])
  @@index([networkId])
  @@index([schoolId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN      // Super Admin
  OFFICE_ADMIN     // เขตพื้นที่
  NETWORK_ADMIN    // เครือข่าย
  SCHOOL_DIRECTOR  // ผู้อำนวยการโรงเรียน
  TEACHER          // ครู/กรรมการ
  VIEWER           // ผู้ดูข้อมูล
}

// ============================================
// ASSESSMENT INDICATORS
// ============================================

// กลุ่มตัวชี้วัด (4 กลุ่ม)
model IndicatorGroup {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(50) // เช่น "LEADERSHIP", "PLC", "TEACHER", "STUDENT"
  name      String   @db.VarChar(255)
  nameEn    String?  @db.VarChar(255) // English name for reference
  orderNo   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  indicators Indicator[]

  @@map("indicator_groups")
}

// ตัวชี้วัด (47 ตัว)
model Indicator {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(50) // เช่น "L1", "PLC1", "T1", "S1"
  title     String   @db.Text
  groupId   String
  orderNo   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     IndicatorGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  responses AssessmentResponse[]

  @@index([groupId])
  @@index([orderNo])
  @@map("indicators")
}

// ============================================
// ASSESSMENT
// ============================================

// แบบประเมิน
model Assessment {
  id        String   @id @default(uuid())
  schoolId  String
  academicYearId String
  semesterId String?
  status    AssessmentStatus @default(DRAFT)
  submittedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ผู้สร้างแบบประเมิน
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Relations
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  semester     Semester?    @relation(fields: [semesterId], references: [id], onDelete: SetNull)
  responses    AssessmentResponse[]
  conditions   DevelopmentCondition[] // สิ่งที่หนุน/ถ่วง (DE)

  @@index([schoolId])
  @@index([academicYearId])
  @@index([semesterId])
  @@index([status])
  @@index([createdById])
  @@unique([schoolId, academicYearId, semesterId, createdById]) // หนึ่งโรงเรียน หนึ่งปีการศึกษา หนึ่งภาคเรียน หนึ่งผู้ประเมิน = หนึ่งแบบประเมิน (รองรับหลายผู้ประเมินต่อโรงเรียน)
  @@map("assessments")
}

enum AssessmentStatus {
  DRAFT      // กำลังกรอก
  IN_PROGRESS // กำลังตรวจสอบ
  SUBMITTED  // ส่งแล้ว
  APPROVED   // อนุมัติแล้ว
  REJECTED   // ถูกปฏิเสธ
}

// คำตอบรายตัวชี้วัด
model AssessmentResponse {
  id           String   @id @default(uuid())
  assessmentId String
  indicatorId  String
  score        Int      // 1-5 คะแนนสภาพที่เป็นอยู่ (Current State)
  desiredScore Int?     // 1-5 คะแนนสภาพที่พึงประสงค์ (Desired State)
  note         String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  indicator  Indicator  @relation(fields: [indicatorId], references: [id], onDelete: Cascade)
  evidence   Evidence[]

  @@index([assessmentId])
  @@index([indicatorId])
  @@unique([assessmentId, indicatorId]) // หนึ่งแบบประเมิน หนึ่งตัวชี้วัด = หนึ่งคำตอบ
  @@map("assessment_responses")
}

// หลักฐานประกอบการประเมิน
model Evidence {
  id           String   @id @default(uuid())
  responseId   String
  fileName     String   @db.VarChar(255)
  originalName String   @db.VarChar(255)
  filePath     String   @db.VarChar(500)
  fileSize     Int      // bytes
  mimeType     String   @db.VarChar(100)
  description  String?  @db.Text
  uploadedAt   DateTime @default(now())

  response AssessmentResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
  @@map("evidence")
}

// ============================================
// DEVELOPMENTAL EVALUATION (DE)
// ============================================

// สิ่งที่หนุน/ถ่วง การพัฒนา (DE-friendly: 1 รายการ = 1 สัญญาณ)
model DevelopmentCondition {
  id            String   @id @default(uuid())
  assessmentId String
  type         ConditionType // สิ่งที่หนุน / สิ่งที่ถ่วง
  // โครงสร้าง DE: [สัญญาณ] → [ผลต่อระบบ/ผู้เรียน] → [ข้อสังเกต]
  signalText    String?  @db.Text // สิ่งที่เกิดขึ้น (เล่าให้เพื่อนฟังได้)
  impactText    String?  @db.Text // ส่งผลต่อการพัฒนาอย่างไร
  reflectionNote String? @db.Text // ข้อสังเกต/คำถามเพื่อการพัฒนา (ไม่บังคับ)
  domain        String?  @db.VarChar(50) // Leadership | PLC | Student | Data | Culture
  month         String?  @db.VarChar(7)  // ปี-เดือน เช่น 2024-01
  // เลกาซี: รายการเก่าอาจมีแค่ description
  description   String?  @db.Text
  category      String?  @db.VarChar(50)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([type])
  @@index([domain])
  @@map("development_conditions")
}

enum ConditionType {
  SUPPORTER // สิ่งที่หนุน
  BLOCKER   // สิ่งที่ถ่วง
}

// บันทึกการเรียนรู้รายเดือน (Learning Timeline)
model LearningLog {
  id        String   @id @default(uuid())
  schoolId  String
  month     String   @db.VarChar(7)  // YYYY-MM เช่น 2568-06
  source    LearningSource @default(OTHER)
  content   String   @db.Text        // สิ่งที่เรียนรู้
  domain    String?  @db.VarChar(50) // Leadership | PLC | Student | Data | Culture
  createdById String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([schoolId])
  @@index([month])
  @@index([createdById])
  @@map("learning_logs")
}

enum LearningSource {
  PLC         // จากวง PLC
  SUPERVISION // จากการนิเทศ
  EXPERIMENT  // จากการทดลอง
  OTHER       // อื่น ๆ
}

// บันทึกวง PLC พร้อม Quality Signals
model PLCSession {
  id              String   @id @default(uuid())
  schoolId        String
  sessionDate     DateTime
  month           String   @db.VarChar(7)  // YYYY-MM
  participants    Int      @default(0)     // จำนวนผู้เข้าร่วม
  deQuestionUsed  String?  @db.Text        // คำถาม DE ที่ใช้ในวง
  keyInsight      String?  @db.Text        // สิ่งที่ได้เรียนรู้จากวง

  // Quality Signals (4 มิติ, 1-5)
  safetyLevel       Int?  // ความปลอดภัยในการพูด
  questionDepth     Int?  // ความลึกของคำถาม
  studentConnection Int?  // การเชื่อมกับผู้เรียน
  actionFollowUp    Int?  // การนำไปทดลองจริงหลัง PLC

  // Reflection สั้น ๆ
  deeperThinking  Boolean? // วันนี้วงช่วยให้คิดลึกขึ้นไหม
  nextTry         String?  @db.Text // มีอะไรอยากลองหลังจากนี้

  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([schoolId])
  @@index([month])
  @@index([createdById])
  @@map("plc_sessions")
}

// เรื่องเล่าการเปลี่ยนแปลงของผู้เรียน (Story Cards)
model StudentSignal {
  id                String   @id @default(uuid())
  schoolId          String
  month             String   @db.VarChar(7)  // YYYY-MM
  studentCode       String   @db.VarChar(50) // รหัสย่อ ไม่ระบุชื่อจริง
  signalDescription String   @db.Text        // สัญญาณที่เห็น
  changeDescription String?  @db.Text        // การเปลี่ยนแปลงที่เกิดขึ้น
  teacherAction     String?  @db.Text        // สิ่งที่ครูปรับ
  createdById       String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([schoolId])
  @@index([month])
  @@index([createdById])
  @@map("student_signals")
}

// การทดลองพัฒนา (Prototypes / Experiments)
model Experiment {
  id            String   @id @default(uuid())
  schoolId      String
  month         String   @db.VarChar(7)  // YYYY-MM เริ่มต้น
  title         String   @db.VarChar(255)
  description   String?  @db.Text
  domain        String?  @db.VarChar(50) // Leadership | PLC | Student | Data | Culture
  duration      String?  @db.VarChar(50) // เช่น "4 สัปดาห์", "8 สัปดาห์"
  status        ExperimentStatus @default(PLANNED)
  lessonLearned String?  @db.Text        // บทเรียนที่ได้
  willContinue  Boolean? // ทำต่อหรือไม่
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([schoolId])
  @@index([month])
  @@index([status])
  @@index([createdById])
  @@map("experiments")
}

enum ExperimentStatus {
  PLANNED      // วางแผนไว้
  IN_PROGRESS  // กำลังทดลอง
  COMPLETED    // เสร็จแล้ว
}

// สะท้อนประจำเดือน (Monthly Reflection + Adaptation)
model MonthlyReflection {
  id               String   @id @default(uuid())
  schoolId         String
  month            String   @db.VarChar(7)  // YYYY-MM
  systemReflection String?  @db.Text        // เรียนรู้อะไรเกี่ยวกับระบบของโรงเรียน
  continueItems    String?  @db.Text        // สิ่งที่ควรทำต่อ
  stopItems        String?  @db.Text        // สิ่งที่ควรหยุด
  expandItems      String?  @db.Text        // สิ่งที่ควรขยาย
  nextSteps        String?  @db.Text        // ก้าวถัดไปเล็ก ๆ
  createdById      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  @@unique([schoolId, month]) // 1 โรงเรียน 1 เดือน = 1 Reflection
  @@index([schoolId])
  @@index([month])
  @@index([createdById])
  @@map("monthly_reflections")
}

// คำถาม DE ประจำเดือน (Seed data — 12 ชุด)
model DEQuestion {
  id              String   @id @default(uuid())
  monthNumber     Int      @unique // 1-12
  focus           String   @db.VarChar(255) // โฟกัสของเดือนนั้น
  questions       String   @db.Text        // JSON array ของคำถาม
  expectedOutcome String?  @db.Text        // ผลลัพธ์ที่อยากเห็น
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("de_questions")
}
